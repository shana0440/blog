{"componentChunkName":"component---src-templates-blog-post-js","path":"/writings/notification-of-ios/","result":{"data":{"site":{"siteMetadata":{"title":"KWGUO Blog"}},"markdownRemark":{"id":"5e491933-c8e9-5466-b982-eed3b936c02a","excerpt":"I’m working on iOS notification recently, the following list is used to let me follow when we working on iOS notification again. How to enable push notification…","html":"<p>I’m working on iOS notification recently, the following list is used to let me follow when we working on iOS notification again.</p>\n<h2>How to enable push notification</h2>\n<ul>\n<li>Go to the apple developer portal, and make your identifiers have the capability to send the notification.</li>\n<li>Open the project by XCode, enable the push notification capability for your app.</li>\n<li>If you want to receive the remote notification, enable the Background Mode, and check the Remote notifications.</li>\n</ul>\n<h2>How to register the device on APNs</h2>\n<p>Create a class to implement <code class=\"language-text\">UIApplicationDelegate</code> and <code class=\"language-text\">UNUserNotificationCenterDelegate</code>, and request notification authorization and register the remote notification when app launch.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UIApplicationDelegate</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UNUserNotificationCenterDelegate</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">application</span><span class=\"token punctuation\">(</span>\n    <span class=\"token omit keyword\">_</span> application<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIApplication</span><span class=\"token punctuation\">,</span>\n    didFinishLaunchingWithOptions launchOptions<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">UIApplication</span><span class=\"token punctuation\">.</span><span class=\"token class-name\">LaunchOptionsKey</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">Any</span><span class=\"token punctuation\">]</span><span class=\"token operator\">?</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Bool</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> center <span class=\"token operator\">=</span> <span class=\"token class-name\">UNUserNotificationCenter</span><span class=\"token punctuation\">.</span><span class=\"token function\">current</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    center<span class=\"token punctuation\">.</span>delegate <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span>\n    center<span class=\"token punctuation\">.</span><span class=\"token function\">requestAuthorization</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>alert<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>sound<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>badge<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> granted<span class=\"token punctuation\">,</span> error <span class=\"token keyword\">in</span>\n      <span class=\"token class-name\">DispatchQueue</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> granted <span class=\"token punctuation\">{</span>\n          <span class=\"token class-name\">UIApplication</span><span class=\"token punctuation\">.</span>shared<span class=\"token punctuation\">.</span><span class=\"token function\">registerForRemoteNotifications</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token class-name\">UIApplication</span><span class=\"token punctuation\">.</span>shared<span class=\"token punctuation\">.</span><span class=\"token function\">unregisterForRemoteNotifications</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> error <span class=\"token operator\">!=</span> <span class=\"token nil constant\">nil</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"Failed requesting notification permission: \"</span></span><span class=\"token punctuation\">,</span> error <span class=\"token operator\">??</span> <span class=\"token string-literal\"><span class=\"token string\">\"\"</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>How to get the device token</h2>\n<p>Handle <code class=\"language-text\">didRegisterForRemoteNotificationsWithDeviceToken</code> callback on <code class=\"language-text\">AppDelegate</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AppDelegate</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">NSObject</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UIApplicationDelegate</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UNUserNotificationCenterDelegate</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">application</span><span class=\"token punctuation\">(</span>\n    <span class=\"token omit keyword\">_</span> application<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UIApplication</span><span class=\"token punctuation\">,</span>\n    didRegisterForRemoteNotificationsWithDeviceToken deviceToken<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Data</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">print</span><span class=\"token punctuation\">(</span>deviceToken<span class=\"token punctuation\">.</span><span class=\"token function\">toDeviceToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">extension</span> <span class=\"token class-name\">Data</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">toDeviceToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">String</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>map <span class=\"token punctuation\">{</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"%02.2hhx\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">joined</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>The <code class=\"language-text\">didRegisterForRemoteNotificationsWithDeviceToken</code> callback only work on real device.</p>\n</blockquote>\n<h2>Verify notification setup correctly</h2>\n<ul>\n<li>Prepare the auth key before send notification, follow this <a href=\"https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/establishing_a_token-based_connection_to_apns\">document</a> to understand and create the auth key.</li>\n<li>Follow this <a href=\"https://developer.apple.com/documentation/usernotifications/sending_push_notifications_using_command-line_tools\">document</a> to verify the notification is setup correctly.</li>\n</ul>\n<blockquote>\n<p>You can register auth key at apple developer portal.</p>\n</blockquote>\n<h3>The problem might encounter</h3>\n<ul>\n<li>The .p8 format is invalid, each line of .p8 file should be 64 chars, if the format is incorrect, openssl will not able to read the key.</li>\n</ul>\n<h2>Receive remote notification</h2>\n<p>Register the follwoing delegate to receive the remote notification.</p>\n<ul>\n<li><code class=\"language-text\">application(_:didReceiveRemoteNotification:)</code></li>\n<li><code class=\"language-text\">application(_:didReceiveRemoteNotification:fetchCompletionHandler:)</code></li>\n</ul>\n<p>The different between the two delegate, is the one have <code class=\"language-text\">fetchCompletionHandler</code> parameters can receive the notification even the app is not at foreground, the other one can only receive the remote notification when app is foreground.</p>\n<h2>Show banner message when app in foreground</h2>\n<p>Like Android, when app in foreground, the notification won’t show by default, add the following code to AppDelegate to show alert when app in foreground.</p>\n<p>This will tell the app how to handle notification when app in the foreground.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function-definition function\">userNotificationCenter</span><span class=\"token punctuation\">(</span>\n  <span class=\"token omit keyword\">_</span> center<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UNUserNotificationCenter</span><span class=\"token punctuation\">,</span>\n  willPresent notification<span class=\"token punctuation\">:</span> <span class=\"token class-name\">UNNotification</span><span class=\"token punctuation\">,</span>\n  withCompletionHandler completionHandler<span class=\"token punctuation\">:</span> <span class=\"token attribute atrule\">@escaping</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">UNNotificationPresentationOptions</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">Void</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">completionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span>badge<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>sound<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span>banner<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Test notification on simulator</h2>\n<p>Although simulator didn’t support register remote notification, but we still can test the notification on the simulator, we can create the notification payload file with <code class=\"language-text\">.apns</code> extension, and drog in the simulator, it will act as it receive the notification.</p>\n<p>The <code class=\"language-text\">.apns</code> payload should look like the following json.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Simulator Target Bundle\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{THE APP BUNDLE ID}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"aps\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"alert\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"title\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"body\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bar\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"foo\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"bar\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>References</h2>\n<ul>\n<li><a href=\"https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/establishing_a_token-based_connection_to_apns\">https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/establishing_a_token-based_connection_to_apns</a></li>\n<li><a href=\"https://developer.clevertap.com/docs/how-to-create-an-ios-apns-auth-key\">https://developer.clevertap.com/docs/how-to-create-an-ios-apns-auth-key</a></li>\n<li><a href=\"https://developer.apple.com/documentation/usernotifications/sending_push_notifications_using_command-line_tools\">https://developer.apple.com/documentation/usernotifications/sending_push_notifications_using_command-line_tools</a></li>\n<li><a href=\"https://developer.apple.com/forums/thread/82950\">https://developer.apple.com/forums/thread/82950</a></li>\n<li><a href=\"https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623013-application\">https://developer.apple.com/documentation/uikit/uiapplicationdelegate/1623013-application</a></li>\n<li><a href=\"https://developer.apple.com/documentation/usernotifications/unusernotificationcenterdelegate/1649518-usernotificationcenter\">https://developer.apple.com/documentation/usernotifications/unusernotificationcenterdelegate/1649518-usernotificationcenter</a></li>\n</ul>","frontmatter":{"title":"Notification of iOS","tags":["writing","iOS","Notification","APNs"],"date":"September 05, 2021","description":"How to setup notification of iOS"}}},"pageContext":{"slug":"/notification-of-ios/","previous":{"fields":{"slug":"/ios-race-conditions/"},"frontmatter":{"title":"iOS race conditions","tags":["writing","ios","swift"]}},"next":{"fields":{"slug":"/android-and-ios-badge-count/"},"frontmatter":{"title":"Android and iOS badge count","tags":["writing","android","ios","badge count","notification"]}}}},"staticQueryHashes":["4111554205","63159454"]}