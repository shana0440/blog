{"componentChunkName":"component---src-templates-blog-post-js","path":"/writings/deep-in-to-bloc/","result":{"data":{"site":{"siteMetadata":{"title":"KWGUO Blog"}},"markdownRemark":{"id":"2db2c94c-d46d-5344-b861-cd3ff0d40286","excerpt":"ç›®å‰æ‰‹ä¸Šçš„å°ˆæ¡ˆæ˜¯æ¡ç”¨ BLoC Patternï¼Œç•¶åˆæ¡ç”¨é€™å€‹ Pattern çš„ç†ç”±æ»¿ç°¡å–®çš„ï¼Œå°±æ˜¯ç¶²è·¯ä¸Šæ»¿å¤šäººæ¨è–¦ï¼Œè€Œä¸”æˆ‘ä¸å–œæ­¡ reduxï¼Œå› ç‚ºå¤ªå¤š boilerplateã€‚ å…ˆä¾†ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ BLoC Pattern å§ï¼Œé€™å€‹ Pattern è·Ÿ MVC, MVVM ä¸€æ¨£ï¼Œéƒ½æ˜¯ç”¨ä¾†å°‡ä¸€äº›å•†æ¥­é‚è¼¯æŠ½é›¢ Viewâ€¦","html":"<p>ç›®å‰æ‰‹ä¸Šçš„å°ˆæ¡ˆæ˜¯æ¡ç”¨ BLoC Patternï¼Œç•¶åˆæ¡ç”¨é€™å€‹ Pattern çš„ç†ç”±æ»¿ç°¡å–®çš„ï¼Œå°±æ˜¯ç¶²è·¯ä¸Šæ»¿å¤šäººæ¨è–¦ï¼Œè€Œä¸”æˆ‘ä¸å–œæ­¡ reduxï¼Œå› ç‚ºå¤ªå¤š boilerplateã€‚</p>\n<p>å…ˆä¾†ç°¡å–®ä»‹ç´¹ä¸€ä¸‹ BLoC Pattern å§ï¼Œé€™å€‹ Pattern è·Ÿ MVC, MVVM ä¸€æ¨£ï¼Œéƒ½æ˜¯ç”¨ä¾†å°‡ä¸€äº›å•†æ¥­é‚è¼¯æŠ½é›¢ Viewï¼Œè®“ View ç›¡é‡å–®ç´”çš„è¨­è¨ˆæ¨¡å¼ï¼ŒBLoC æ˜¯ç”¨ Stream ä¾†é€šçŸ¥ View state çš„æ”¹è®Šï¼Œview å‰‡é‡å°é€™å€‹ state ä¾†å»ºç«‹ widgetï¼Œç¶²è·¯ä¸Šå·²ç¶“æœ‰ä¸å°‘æ–‡ç« å†ä»‹ç´¹ BLoC Pattern äº†ï¼Œæˆ‘ä¹Ÿå°±ä¸ç‰¹åˆ¥èŠ±ç¯‡å¹…é‡æ–°ä»‹ç´¹ï¼Œçœ‹éé€™å€‹<a href=\"https://www.youtube.com/watch?v=PLHln7wHgPE\">å½±ç‰‡</a>ï¼Œå°±æ‡‰è©²æœƒæœ‰ä¸å°‘äº†è§£äº†ã€‚</p>\n<p>ç¾åœ¨æˆ‘å€‘ä¾†ä½¿ç”¨ BLoC Pattern å¯«ä¸€å€‹æ ¹æ“šä½¿ç”¨è€…è¼¸å…¥çš„é—œéµå­—ï¼Œä¾†æœå°‹åˆ—è¡¨çš„ Widget å§ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">BlocSearchListBloc</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Bloc</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BlocSearchListEvent</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">BlocSearchListState</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">ItemRepository</span> _itemRepo <span class=\"token operator\">=</span> <span class=\"token class-name\">GetIt.I</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemRepository</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">BlocSearchListState</span> <span class=\"token keyword\">get</span> initialState <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token class-name\">IdleState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BlocSearchListState</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">mapEventToState</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">BlocSearchListEvent</span> event<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token keyword\">async*</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">is</span> <span class=\"token class-name\">SearchEvent</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">yield</span> <span class=\"token class-name\">LoadingState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">final</span> items <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> _itemRepo<span class=\"token punctuation\">.</span><span class=\"token function\">searchItems</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>keyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">yield</span> <span class=\"token class-name\">DisplayState</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> keyword<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SearchEvent</span><span class=\"token punctuation\">(</span>keyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SearchList</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">StatelessWidget</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">Widget</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Column</span><span class=\"token punctuation\">(</span>\n      children<span class=\"token punctuation\">:</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Widget</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">[</span>\n        <span class=\"token class-name\">TextField</span><span class=\"token punctuation\">(</span>onChanged<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">final</span> bloc <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>bloc<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BlocSearchListBloc</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          bloc<span class=\"token punctuation\">.</span><span class=\"token function\">search</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token class-name\">Expanded</span><span class=\"token punctuation\">(</span>\n          child<span class=\"token punctuation\">:</span> <span class=\"token class-name\">BlocBuilder</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BlocSearchListBloc</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">BlocSearchListState</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>\n            builder<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BuildContext</span> context<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">is</span> <span class=\"token class-name\">LoadingState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"loading...\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n\n              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">is</span> <span class=\"token class-name\">DisplayState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>isEmpty<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                  <span class=\"token keyword\">return</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"no result\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                <span class=\"token keyword\">return</span> <span class=\"token class-name\">ListView</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span>\n                  itemCount<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\n                  itemBuilder<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token class-name\">ListTile</span><span class=\"token punctuation\">(</span>\n                      title<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token punctuation\">}</span>\n\n              <span class=\"token keyword\">return</span> <span class=\"token class-name\">Text</span><span class=\"token punctuation\">(</span><span class=\"token string-literal\"><span class=\"token string\">\"try search something\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ä¸Šé¢æ˜¯ä¸€å€‹ç¶“å…¸çš„ BLoC Patternï¼Œå¯ä»¥çœ‹åˆ°æˆ‘å€‘çš„ View å–®ç´”çš„æ ¹æ“š state ä¾†ç”¢ç”Ÿ widget ï¼ŒæˆåŠŸçš„åˆ†é›¢äº†å•†æ¥­é‚è¼¯è·Ÿç•«é¢ï¼Œä½†é€™æ®µç¨‹å¼æœ‰å€‹å•é¡Œï¼Œç•¶ä½¿ç”¨è€…è¼¸å…¥ <code class=\"language-text\">abcd</code> çš„æ™‚å€™ï¼Œæˆ‘å€‘æ‡‰è©²åªéœ€è¦é—œæ³¨ <code class=\"language-text\">abcd</code> çš„çµæœå°±å¥½äº†ï¼Œå‰é¢çš„çµæœå°æˆ‘å€‘è€Œè¨€æ˜¯ä¸é‡è¦çš„ï¼Œä½†é€™æ®µç¨‹å¼å»æœƒå–å¾— <code class=\"language-text\">a</code> çš„çµæœå¾Œï¼Œå†å»å–å¾— <code class=\"language-text\">ab</code> çš„çµæœï¼Œä»¥æ­¤é¡æ¨ï¼Œæœ€å¾Œå–å¾— <code class=\"language-text\">abcd</code> çš„çµæœçš„æ™‚å€™ï¼Œæˆ‘å€‘å·²ç¶“ç­‰å¾…äº† <code class=\"language-text\">a</code>, <code class=\"language-text\">ab</code>, <code class=\"language-text\">abc</code>, <code class=\"language-text\">abcd</code> å››å€‹ query çš„æ™‚é–“ï¼Œé€™å°è‡´ä½¿ç”¨è€…æœƒè¦ºå¾—ç•«é¢å¡ä½äº†ï¼Œä¸€ç›´å¡åœ¨ <code class=\"language-text\">LoadingState</code>ã€‚</p>\n<h2>Deep in to BLoC source code</h2>\n<p>é€é BLoC source code ä¾†æ‰¾æ‰¾çœ‹å•é¡Œåœ¨å“ªè£¡ï¼Œæˆ‘é€™é‚Šåªç¯€éŒ„ä¸€äº›ç›¸é—œçš„ functionã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">abstract</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Bloc</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">State</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Sink</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">final</span> <span class=\"token class-name\">PublishSubject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">></span></span> _eventSubject <span class=\"token operator\">=</span> <span class=\"token class-name\">PublishSubject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">BehaviorSubject</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span><span class=\"token punctuation\">></span></span> _stateSubject<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/// Transforms the [events] stream along with a [next] function into a `Stream&lt;State>`.</span>\n  <span class=\"token comment\">/// Events that should be processed by [mapEventToState] need to be passed to [next].</span>\n  <span class=\"token comment\">/// By default `asyncExpand` is used to ensure all [events] are processed in the order</span>\n  <span class=\"token comment\">/// in which they are received. You can override [transformEvents] for advanced usage</span>\n  <span class=\"token comment\">/// in order to manipulate the frequency and specificity with which [mapEventToState]</span>\n  <span class=\"token comment\">/// is called as well as which [events] are processed.</span>\n  <span class=\"token comment\">///</span>\n  <span class=\"token comment\">/// For example, if you only want [mapEventToState] to be called on the most recent</span>\n  <span class=\"token comment\">/// [event] you can use `switchMap` instead of `asyncExpand`.</span>\n  <span class=\"token comment\">///</span>\n  <span class=\"token comment\">/// ```dart</span>\n  <span class=\"token comment\">/// @override</span>\n  <span class=\"token comment\">/// Stream&lt;State> transformEvents(events, next) => events.switchMap(next);</span>\n  <span class=\"token comment\">/// ```</span>\n  <span class=\"token comment\">///</span>\n  <span class=\"token comment\">/// Alternatively, if you only want [mapEventToState] to be called for distinct [events]:</span>\n  <span class=\"token comment\">///</span>\n  <span class=\"token comment\">/// ```dart</span>\n  <span class=\"token comment\">/// @override</span>\n  <span class=\"token comment\">/// Stream&lt;State> transformEvents(events, next) {</span>\n  <span class=\"token comment\">///   return super.transformEvents(</span>\n  <span class=\"token comment\">///     events.distinct(),</span>\n  <span class=\"token comment\">///     next,</span>\n  <span class=\"token comment\">///   );</span>\n  <span class=\"token comment\">/// }</span>\n  <span class=\"token comment\">/// ```</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">transformEvents</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">></span></span> events<span class=\"token punctuation\">,</span>\n    <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Function</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Event</span><span class=\"token punctuation\">)</span> next<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> events<span class=\"token punctuation\">.</span><span class=\"token function\">asyncExpand</span><span class=\"token punctuation\">(</span>next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">mapEventToState</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Event</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/// Transforms the `Stream&lt;State>` into a new `Stream&lt;State>`.</span>\n  <span class=\"token comment\">/// By default [transformStates] returns the incoming `Stream&lt;State>`.</span>\n  <span class=\"token comment\">/// You can override [transformStates] for advanced usage</span>\n  <span class=\"token comment\">/// in order to manipulate the frequency and specificity at which `transitions` (state changes)</span>\n  <span class=\"token comment\">/// occur.</span>\n  <span class=\"token comment\">///</span>\n  <span class=\"token comment\">/// For example, if you want to debounce outgoing [states]:</span>\n  <span class=\"token comment\">///</span>\n  <span class=\"token comment\">/// ```dart</span>\n  <span class=\"token comment\">/// @override</span>\n  <span class=\"token comment\">/// Stream&lt;State> transformStates(Stream&lt;State> states) {</span>\n  <span class=\"token comment\">///   return states.debounceTime(Duration(seconds: 1));</span>\n  <span class=\"token comment\">/// }</span>\n  <span class=\"token comment\">/// ```</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">transformStates</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span><span class=\"token punctuation\">></span></span> states<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> states<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">_bindStateSubject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Event</span> currentEvent<span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">transformStates</span><span class=\"token punctuation\">(</span><span class=\"token function\">transformEvents</span><span class=\"token punctuation\">(</span>_eventSubject<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Event</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      currentEvent <span class=\"token operator\">=</span> event<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">mapEventToState</span><span class=\"token punctuation\">(</span>currentEvent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span>_handleError<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">(</span><span class=\"token class-name\">State</span> nextState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">==</span> nextState <span class=\"token operator\">||</span> _stateSubject<span class=\"token punctuation\">.</span>isClosed<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">final</span> transition <span class=\"token operator\">=</span> <span class=\"token class-name\">Transition</span><span class=\"token punctuation\">(</span>\n          currentState<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">,</span>\n          event<span class=\"token punctuation\">:</span> currentEvent<span class=\"token punctuation\">,</span>\n          nextState<span class=\"token punctuation\">:</span> nextState<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token class-name\">BlocSupervisor</span><span class=\"token punctuation\">.</span>delegate<span class=\"token punctuation\">.</span><span class=\"token function\">onTransition</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> transition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">onTransition</span><span class=\"token punctuation\">(</span>transition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          _stateSubject<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>nextState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">on</span> <span class=\"token class-name\">Object</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">_handleError</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å¯ä»¥çœ‹åˆ° BLoC çš„ç¨‹å¼ç¢¼éå¸¸ç°¡å–®ï¼Œé¦–å…ˆæœ€é‡è¦çš„å°±æ˜¯ <code class=\"language-text\">_bindStateSubject</code> äº†ï¼Œé€™é‚Šé€é <code class=\"language-text\">transformEvents</code> æŠŠ event è½‰è®Šç‚º state, å†é€é <code class=\"language-text\">transformStates</code> æŠŠ state è®Šæˆ stateï¼Œä¹‹å¾Œåœ¨æŠŠ state åŠ åˆ° <code class=\"language-text\">_stateSubject</code> ä¸­ï¼Œæˆ‘å€‘çš„ view å°±æœƒé‡å°é€™å€‹ state é€²è¡Œé‡å»ºã€‚</p>\n<p>ä¾†çœ‹ä¸€ä¸‹ <code class=\"language-text\">transformEvents</code>ï¼Œé€™é‚Šé€é <code class=\"language-text\">asyncExpand</code> æŠŠ event è½‰æˆ stateï¼Œ<code class=\"language-text\">asyncExpand</code> æœƒç¢ºä¿ event è¢«æ­£ç¢ºè™•ç†å®Œç•¢ä¹‹å¾Œï¼Œæ‰è™•ç†ä¸‹ä¸€å€‹ event ï¼Œé€™å°±æ˜¯æˆ‘å€‘ä¸Šé¢é‡åˆ°çš„å•é¡Œï¼è¨»è§£ä¹Ÿæœ‰èªªæ˜ï¼Œæˆ‘å€‘å¯ä»¥ override é€™å€‹ function ï¼Œæ”¹æˆ <code class=\"language-text\">events.switchMap(next)</code> ï¼Œå°±æœƒè®Šæˆåªå–å¾—æœ€å¾Œä¸€å€‹ eventï¼Œè€Œé€™æ°å¥½å°±æ˜¯æˆ‘å€‘è¦çš„ã€‚</p>\n<p>æˆ‘å€‘ä¹Ÿä¾†çœ‹ä¸€ä¸‹ <code class=\"language-text\">asyncExpand</code> çš„åŸå§‹ç¢¼å§</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> asyncExpand<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    _StreamControllerBase<span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> controller<span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">StreamSubscription</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> subscription<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">onListen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">assert</span><span class=\"token punctuation\">(</span>controller <span class=\"token operator\">is</span> _StreamController <span class=\"token operator\">||</span>\n          controller <span class=\"token operator\">is</span> _BroadcastStreamController<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      subscription <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> event<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span> newStream<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n          newStream <span class=\"token operator\">=</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          controller<span class=\"token punctuation\">.</span><span class=\"token function\">addError</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newStream <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          subscription<span class=\"token punctuation\">.</span><span class=\"token function\">pause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          controller<span class=\"token punctuation\">.</span><span class=\"token function\">addStream</span><span class=\"token punctuation\">(</span>newStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">whenComplete</span><span class=\"token punctuation\">(</span>subscription<span class=\"token punctuation\">.</span>resume<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          onError<span class=\"token punctuation\">:</span> controller<span class=\"token punctuation\">.</span>_addError<span class=\"token punctuation\">,</span> <span class=\"token comment\">// Avoid Zone error replacement.</span>\n          onDone<span class=\"token punctuation\">:</span> controller<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>isBroadcast<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      controller <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StreamController</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">.</span><span class=\"token function\">broadcast</span><span class=\"token punctuation\">(</span>\n          onListen<span class=\"token punctuation\">:</span> onListen<span class=\"token punctuation\">,</span>\n          onCancel<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            subscription<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token keyword\">sync</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      controller <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StreamController</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">E</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>\n          onListen<span class=\"token punctuation\">:</span> onListen<span class=\"token punctuation\">,</span>\n          onPause<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            subscription<span class=\"token punctuation\">.</span><span class=\"token function\">pause</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          onResume<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            subscription<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          onCancel<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> subscription<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token keyword\">sync</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> controller<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">asyncExpand</code> æœ€é‡è¦çš„å°±æ˜¯é‚£æ®µ <code class=\"language-text\">onListen</code> äº†ï¼Œ<code class=\"language-text\">convert</code> å°±æ˜¯æˆ‘å€‘çš„ <code class=\"language-text\">mapEventToState</code>ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœ <code class=\"language-text\">convert</code> å›å‚³ä¸€å€‹ stream çš„è©±ï¼Œæˆ‘å€‘æœƒæš«åœç›®å‰çš„ streamï¼Œä¹Ÿå°±æ˜¯ eventsï¼Œç›´åˆ° <code class=\"language-text\">newStream</code> ç™¼å‡º done eventï¼Œæ‰æœƒç¹¼çºŒè™•ç†ä¸‹ä¸€å€‹ eventã€‚</p>\n<p><code class=\"language-text\">transformStates</code> é è¨­æ˜¯ä»€éº¼éƒ½ä¸åšï¼Œæˆ‘ä¹Ÿæš«æ™‚æƒ³ä¸åˆ°æœƒæœ‰ä»€éº¼éœ€æ±‚æ˜¯è¦å‹•åˆ° <code class=\"language-text\">transformStates</code> ğŸ¤”</p>\n<p>å›åˆ°ä¸€é–‹å§‹çš„ç¯„ä¾‹ï¼Œè¦è®“ä»–æ­£å¸¸é‹ä½œï¼Œæˆ‘å€‘åªéœ€è¦æŠŠ BLoC ä¿®æ”¹ç‚ºä¸‹é¢é€™æ®µç¨‹å¼ç¢¼å³å¯ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"dart\"><pre class=\"language-dart\"><code class=\"language-dart\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">BlocSearchListBloc</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Bloc</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BlocSearchListEvent</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">BlocSearchListState</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">ItemRepository</span> _itemRepo <span class=\"token operator\">=</span> <span class=\"token class-name\">GetIt.I</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ItemRepository</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">BlocSearchListState</span> <span class=\"token keyword\">get</span> initialState <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token class-name\">IdleState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BlocSearchListState</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">transformEvents</span><span class=\"token punctuation\">(</span>events<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> events<span class=\"token punctuation\">.</span><span class=\"token function\">switchMap</span><span class=\"token punctuation\">(</span>next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token metadata function\">@override</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BlocSearchListState</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">mapEventToState</span><span class=\"token punctuation\">(</span>\n    <span class=\"token class-name\">BlocSearchListEvent</span> event<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token keyword\">async*</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event <span class=\"token operator\">is</span> <span class=\"token class-name\">SearchEvent</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">yield</span> <span class=\"token class-name\">LoadingState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">final</span> items <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> _itemRepo<span class=\"token punctuation\">.</span><span class=\"token function\">searchItems</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>keyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">yield</span> <span class=\"token class-name\">DisplayState</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">void</span> <span class=\"token function\">search</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> keyword<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SearchEvent</span><span class=\"token punctuation\">(</span>keyword<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Deep in to BLoC","tags":["writing","flutter","state","bloc"],"date":"March 08, 2020","description":"introduce BLoC pattern and the problem I encounter"}}},"pageContext":{"slug":"/deep-in-to-bloc/","previous":{"fields":{"slug":"/android-intent-flag_activity_new_task/"},"frontmatter":{"title":"Android Intent FLAG_ACTIVITY_NEW_TASK","tags":["writing","android","intent"]}},"next":{"fields":{"slug":"/flutter-setstate/"},"frontmatter":{"title":"flutter setState","tags":["writing","flutter","state"]}}}},"staticQueryHashes":["4111554205","63159454"]}