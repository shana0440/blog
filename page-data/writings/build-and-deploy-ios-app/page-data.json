{"componentChunkName":"component---src-templates-blog-post-js","path":"/writings/build-and-deploy-ios-app/","result":{"data":{"site":{"siteMetadata":{"title":"KWGUO Blog"}},"markdownRemark":{"id":"5245cdf3-5ed4-5895-9606-9e9aecb25d46","excerpt":"由於最近工作上在寫 Flutter，而最近這專案差不多要結束了，所以負責把這個 app 上架到 app store 上，中間也是遇到不少令人疑惑的問題，因此在這邊紀錄一下，將來有機會遇到的時候，應該比較容易回憶起來。 基礎知識 首先，先來了解一下一個 iOS app 如果要能在 device…","html":"<p>由於最近工作上在寫 Flutter，而最近這專案差不多要結束了，所以負責把這個 app 上架到 app store 上，中間也是遇到不少令人疑惑的問題，因此在這邊紀錄一下，將來有機會遇到的時候，應該比較容易回憶起來。</p>\n<h2>基礎知識</h2>\n<p>首先，先來了解一下一個 iOS app 如果要能在 device 上運作，需要什麼東西：</p>\n<ol>\n<li>certificate\n<ul>\n<li>用來證明是誰發布這個 app 的。</li>\n</ul>\n</li>\n<li>identifier\n<ul>\n<li>必須是全世界唯一的識別碼。</li>\n</ul>\n</li>\n<li>provision profile\n<ul>\n<li>一個配置文件，用來描述在 device 上需要用到什麼服務。</li>\n</ul>\n</li>\n</ol>\n<h3>Certificate</h3>\n<p>Certificate 是用來證明這個 app 是我們發佈的，這樣 device 才可以安心的安裝這個 app，而不會安裝到來路不明的 app，所有的 certificate 都統一由 apple 來發送。</p>\n<p>為了申請一個 Certificate，首先需要建立一個 csr (certificate signing request)，參照這個<a href=\"https://stackoverflow.com/a/45504269\">回答</a>，我們可以從 keychain 中建立 csr，要注意的是 common name 會顯示在 keychain 上面，所以記得取一個比較容易辨識的名字，像 <code class=\"language-text\">my_ios_distribution</code> 之類的。</p>\n<p>經過上面的步驟得到 csr 之後，就可以到 apple developer 上建立 certificate，上傳 csr 之後，apple 就會讓我們下載一個 cer (certificate)，但事情還沒結束！這個 cer 只是 apple 發給我們的憑證，但是這個憑證還不能拿來 sign app，因為這個憑證只是 public key，而我們要使用 private key 來 sign app 才行，這個 cer 只是代表如果我們用 private key 來 sign app 之後， apple 會能夠驗證這個 app 是由我們發布的。</p>\n<p>在建立 csr 的時候，就會自動建立一個 private key，當我們拿到 cer 之後，點兩下來 import 到 keychain，接下來照這個<a href=\"https://stackoverflow.com/a/44696730\">回答</a>我們就可以透過 keychain 來匯出 p12 (Public Key Cryptography Standards) 包含 private key 和 certificate。</p>\n<p>有了這個 p12，我們就可以在任何電腦上來 sign app 了，這對於持續發布是非常重要的，如果只是要在自己的電腦上 sign app 的話，那就不需用輸出這個 p12 了，因為自己的電腦就包含了 private key &#x26; certificate 了。</p>\n<h3>Identifier</h3>\n<p>在開發 app 的時候，都要輸入一個 app id (identifier)，而這個 app id 必須是全世界唯一的，出現在 A account，就不能出現在 B account，所以在開發 app 的時候常常會看到什麼要換個 unique 的 id，就是因為被別人搶走了。</p>\n<p>在 apple developer 的網頁上，我們可以註冊這個 identifier，這在之後建立 provision profile 的時候會用到，並且在建立 identifier 的時候，需要選擇這個 app 能做到什麼事情，像是 push notification 之類的，都是在建立 identifier 的時候做選擇。</p>\n<h3>Provision Profile</h3>\n<p>這是一個配置文件，讓 device 知道我們這個 app 需要用到什麼服務，如果 profile 上的描述不符合 device 上的情況的話，聽說 app 就開不了了，當然我沒遇過所以也不清楚。</p>\n<p>在 apple developer 網站上建立 provision profile 的時候，會需要選擇 certificate &#x26; identifier，這邊就是在連結這個 app 能做到的事情，以及用來 sign 的 certificate。</p>\n<p>建立 profile 的時候，會需要選擇是開發用的還是發布用的，發布用的比較複雜，要選擇發布到哪裡，如果沒有選對，就要重建立一次，像 Ad-Hoc 就是用來測試用的，在 apple developer 上註冊的 device 就可以安裝這個 app，app store 就是用來發布的，用來上傳到 itunes connect 的。</p>\n<h2>發布 app</h2>\n<p>這邊是一些發布 app 用的 script，因為我是寫 flutter 的，所以 build script 主要是以 flutter 為主。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># create application bundle</span>\nflutter build ios <span class=\"token parameter variable\">--verbose</span> <span class=\"token parameter variable\">--flavor</span> <span class=\"token variable\">${FLAVOR}</span> --no-codesign <span class=\"token parameter variable\">--quiet</span> <span class=\"token parameter variable\">--release</span> --build-number <span class=\"token variable\">${BUILD_NUMBER}</span>\n<span class=\"token comment\"># create build archive</span>\nxcodebuild <span class=\"token parameter variable\">-workspace</span> ./ios/Runner.xcworkspace <span class=\"token parameter variable\">-scheme</span> <span class=\"token variable\">${FLAVOR}</span> <span class=\"token parameter variable\">-sdk</span> iphoneos <span class=\"token parameter variable\">-configuration</span> Release-<span class=\"token variable\">${FLAVOR}</span> archive <span class=\"token parameter variable\">-archivePath</span> ./build/<span class=\"token variable\">${MY_APP}</span>_<span class=\"token variable\">${FLAVOR}</span>.xcarchive <span class=\"token parameter variable\">-quiet</span>\n<span class=\"token comment\"># export xcarchive to ipa</span>\nxcodebuild <span class=\"token parameter variable\">-exportArchive</span> <span class=\"token parameter variable\">-archivePath</span> ./build/<span class=\"token variable\">${MY_APP}</span>_<span class=\"token variable\">${FLAVOR}</span>.xcarchive <span class=\"token parameter variable\">-exportOptionsPlist</span> <span class=\"token variable\">${EXPORT_OPTIONS_PLIST_PATH}</span> <span class=\"token parameter variable\">-exportPath</span> ./build/<span class=\"token variable\">${MY_APP}</span>_<span class=\"token variable\">${FLAVOR}</span>.ipa <span class=\"token parameter variable\">-quiet</span>\n<span class=\"token comment\"># upload ipa to itunes connect</span>\nxcrun altool --upload-app <span class=\"token parameter variable\">--type</span> ios <span class=\"token parameter variable\">--file</span> <span class=\"token variable\">${IPA_PATH}</span> <span class=\"token parameter variable\">--username</span> <span class=\"token variable\">${USERNAME}</span> <span class=\"token parameter variable\">--password</span> <span class=\"token variable\">${PASSWORD}</span></code></pre></div>\n<p>這邊的 <code class=\"language-text\">flavor</code> 指的是 xcode 上的 scheme，這個專案為了在不同的 build 上使用不同的 crashlytics，所以有多個 scheme，如此一來可以寫一個 build script，針對不同的 scheme 來使用不同的 <code class=\"language-text\">GoogleService-Info.plist</code>。</p>\n<p>當專案有個不同的 scheme，我們就沒辦法使用 xcode 來 archive 了，因為 xcode 的 archive 在我使用的時候，並不會指定 flavor，導致 archive 會失敗，所以這邊我們使用 command line 來執行，再說，我們的最終目標就是自動化，為此將所有步驟指令化是早晚都要做的。</p>\n<p>產生了 <code class=\"language-text\">.xcarchive</code> 之後，我們就可以來將 archive 轉成 ipa 了，要注意的是，第一次 export 時，因為我們並沒有 <code class=\"language-text\">ExportOptions.plist</code>，所以要使用 xcode 來 export，只要使用 <code class=\"language-text\">open ${ARCHIVE_PATH}</code> ，xcode 就會開啟 archive。</p>\n<p>最後就是上傳 ipa 到 itunes connect 了，這邊要先在 itunes connect 上建立對應的 app 才能上傳，不然會有找不到對應的 app 的錯誤訊息，要注意的是，每個 build number 只能上傳一次，所以每次上傳時 build number 都必須是唯一的。</p>\n<p>上傳之後要等 apple 驗證一下 app 有沒有把該填的資料都填一填，驗證完之後會送一封信到信箱，說明是通過了，還是缺少什麼資料，如果有缺少資料，那信的內容大概是長這樣。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/dea2ba77f21362552e4c27d3204f9953/ace37/upload-to-itunes-connect-failed.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACzklEQVQ4yz1TDXOqMBDk//+211YFAkkgCQEUUARFRGvrvrmzLTM3d7mPALt7gdYaaZpCKQWK8zyHtZZj8pR3zqGuaxRFgbIsOU993ns2OlNP13UIqKGqKhhjeICKdCb/22is5UGK6SKaod6i8MiyjPMUt3QhfUEYRRBCcEGIhM9JkiCKImRaQysJmSbQKmWfJoK9yTOOySciRll6BCpNkGcKhbMQccQ+zzSklPy7qcqwjjXeNylWscIq1tgIjY9Qcky1MMnxthawvkYg/YDt8MBuuMPUA/rLE9XhinmeQc/l9g23v6HsH2zF4ZP7y+MD/vDJVvavXD99IdC2QpTmUKZE5ipkrkbuamy3W7Rti91ui8O+xWk84tgfMA499l2LfddwTNYfOhz2HabzCYEvHEpfwJqcjfCoq5LBJqLIZ1mOwnvkxrC9yDGwzr3qrAyHpm0RUEEpjVRKHqJYSsUYkv1Kh9glo9zrJRnXSHK/MiNpBTIViMINlHwxSEbkEMvr9RpJkvIlYRgijmNWQxxFrADqIVVQfbVasZQCZWu0xxndcYIyFYbphrodWKSPzzvafsLGHBG5EaIYEdoRqjojLk6I7IDQDhDFCakfmcxA+h6J3SOvjsyy240w9RHTdMayLJimC86XGdflhsu8YL4uOE8zztMF83L7yV8xXa5YlhsCZw3rjsjItIQxGYgowoRIIYycs39bVBQOJs8Zw8I5uB/8CN+m2SF4rVfBrPGaGQNjLA9QE62d/onp0l8yiGGaIwJplmZ2TYNAypTBF3HMQwR8uNkw4AQ0kZVriUREkEkMIjEh0kTEf0Q52rQoXKP0DoFUGlW9xW7XMKNdt4cvS/7StmlY5P9ijzfh8ZGWeEtKbFSN96TkHPmVrPEuHGx9QKC3M69T2d/h2iua8Qt+v+DxePDqfX4Bw/yN8fpko/i0PP/O4/Wb7bw8Md+f+A/vI4wwFrQxHQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"upload-to-itunes-connect-failed.png\"\n        title=\"upload-to-itunes-connect-failed.png\"\n        src=\"/blog/static/dea2ba77f21362552e4c27d3204f9953/fcda8/upload-to-itunes-connect-failed.png\"\n        srcset=\"/blog/static/dea2ba77f21362552e4c27d3204f9953/12f09/upload-to-itunes-connect-failed.png 148w,\n/blog/static/dea2ba77f21362552e4c27d3204f9953/e4a3f/upload-to-itunes-connect-failed.png 295w,\n/blog/static/dea2ba77f21362552e4c27d3204f9953/fcda8/upload-to-itunes-connect-failed.png 590w,\n/blog/static/dea2ba77f21362552e4c27d3204f9953/ace37/upload-to-itunes-connect-failed.png 666w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>根據上面信封來修改 app 的一些設定，在上傳一次就行惹，之後就可以到 TestFight 邀請測試人員來測試這些 app。</p>\n<h2>Reference</h2>\n<ul>\n<li><a href=\"https://medium.com/@abhimuralidharan/what-is-a-provisioning-profile-in-ios-77987a7c54c2\">https://medium.com/@abhimuralidharan/what-is-a-provisioning-profile-in-ios-77987a7c54c2</a></li>\n<li><a href=\"https://help.apple.com/xcode/mac/current/#/dev60b6fbbc7\">https://help.apple.com/xcode/mac/current/#/dev60b6fbbc7</a></li>\n<li><a href=\"https://kknews.cc/zh-tw/news/rrx9e6v.html\">https://kknews.cc/zh-tw/news/rrx9e6v.html</a></li>\n<li><a href=\"https://www.itread01.com/p/376503.html\">https://www.itread01.com/p/376503.html</a></li>\n</ul>","frontmatter":{"title":"Build and Deploy iOS app","tags":["writing","flutter","ios","deployment","app store","sign"],"date":"February 29, 2020","description":"How to create a ipa and upload to itunes connect"}}},"pageContext":{"slug":"/build-and-deploy-ios-app/","previous":{"fields":{"slug":"/flutter-performance-overview/"},"frontmatter":{"title":"Flutter Performance Overview","tags":["writing","flutter","performance","render"]}},"next":{"fields":{"slug":"/flutter-inherited-widget/"},"frontmatter":{"title":"Flutter Inherited Widget","tags":["writing","flutter","state","inherited widget"]}}}},"staticQueryHashes":["4111554205","63159454"]}